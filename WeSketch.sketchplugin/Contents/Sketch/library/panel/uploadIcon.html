<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <script type="text/javascript" src="js/jquery.js"></script>
    <link href="css/normalize.css" rel="stylesheet">
    <style type="text/css">
    body,html{
      height:100%;
      background-color: #ececec;
      font-size: 14px;
    }
    .wrap{
      padding: 0 0 0 0;
    }
    .label-wrap{
      margin-top: 20px;
    }
    .label-wrap label{
      width: 60px;
      display: block;
    }
    .label-wrap{
      display: flex;
    }
    .ui-item{
      flex:1;
    }
    .svg-wrap{
      text-align: center;
      background: white;
      width: 350px;
      padding: 20px;
      float: left;
    }
    .svg-message{
      padding-left: 25px;
      flex:1;
      background: #EFEFEF;
      border-left:1px solid #D8D7D8;
    }
    .svg-wrap svg{
      max-width: 64px;
      max-height: 64px;
    }
    .svg-wrap>div{
      margin-bottom: 10px;
    }
    .svg-title{
      margin-bottom: 10px;
    }
    .svg-w{
      border-radius: 5px;
      float:left;
      background: #bebebe;
      width:80px;
      height:80px;
      display: flex;
      justify-content:center;
      align-items: center;
      position: relative;
    }
    .active.svg-w:before{
      border-radius: 5px;
      position: absolute;
      content: " ";
      width:100%;
      height:100%;
      box-sizing:border-box;
      border:2px solid #79B7F4;
      left:0;
      top:0;
    }
    .svg-w+.svg-w{
      margin-left: 10px;
    }
    .svg-w>svg{
      max-width: 60px;
      max-height: 60px; 
    }
    .input-width{
      width:140px;
      resize:none;
      border:1px solid rgba(0,0,0,0.25);
    }
    .savebutton{
      background:#4fa3f6;
      color:white;
      border: 1px solid #1465fb;
      width:76px;
      text-align: center;
      float:right;
      cursor: pointer;
      font-size: 12px;
      border-radius: 5px;
      background: linear-gradient(0deg,#6ab3fa 0%,#087fff 100%);
      line-height: 20px;
    }
    .savebutton:active{
      background:#3485f0;
    }
    .buttonwrap{
      margin-top:10px;
    }
    .cancelbutton{
      margin-right:10px;
      width:76px;
      text-align: center;
      border: 1px solid #D9D9D9;
      border-radius: 5px;
      color: #262626;
      float:right;
      cursor: pointer;
      font-size: 12px;
      line-height: 20px;
      background: linear-gradient(0deg,#fefefe 0%,#f1f1f1 100%);
    }
    .register{
      display: block;
      margin:10px;
      float:right;
      color:#1A8CC2;
      font-size: 12px;
      cursor: pointer;
    }
    .a-link{
      margin-left:-50px;
      cursor: pointer;
      color:#08B3F6;
    }
    .ui-flex{
      display:flex;
    }
    .ui-flex__item{
      flex:1;
      text-align: center;
    }
    .svg-button{
      padding: 10px 20px;
      border-top:1px solid #D8D7D8;
    }
    .button-title{
      margin: 20px 0 15px 0;
      font-size: 14px;
      color: #000000;
    }
    .svg-upload{
      display: flex;
      height: 300px;
    }
    </style>
  </head>
  <body >
    <div class="wrap">
      <div class="svg-upload">
        <div class="svg-wrap" id="svg-wrap">
        </div>
        <div class="svg-message">
          <div class="label-wrap">
            <label>Name：</label>
            <div class="ui-item">
              <input id="svg-name" class="input-width" type="text" />
            </div>
          </div>
          <div class="label-wrap">
            <label>Author：</label>
            <div class="ui-item">
              <input readonly="readonly" id="upload-username" class="input-width" type="text" />
            </div>
          </div>
          <div class="label-wrap">
            <label>Version：</label>
            <div class="ui-item">
              <input readonly="readonly" id="upload-version"  class="input-width" type="text" />
            </div>
          </div>
          <div class="label-wrap">
            <label>Remark：</label>
            <div class="ui-item">
              <textarea class="input-width" id="upload-mark" style="height:80px"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="svg-button">
        <span class="button-title">Project:</span>
        <span>
        <select id="project" class="input-width" ></select>
        </span>
        <span class="button-title">Category:</span>
        <span>
        <select id="type" class="input-width" ></select>
        </span>
        <div style="float:right;">
            <div id="upload" class="savebutton">Upload</div>
            <div id="cancel" class="cancelbutton">Cancel</div>
        </div>
      </div>
    </div>
  <script type="text/javascript">
    var saveSvg = [];
    var projectID = '';
    var typeID = '';
    var project = [];
    var controli = 0;
    var saveversion = 0;
    function svgUpload(data){
      saveSvg = saveSvg.concat(data);
      var svgDom = [];
      for(var i = 0;i<data.length;i++){
        if(i % 4 == 0){
          svgDom.push('<div>');
        }
        svgDom.push(
            '<div data-i="'+i+'" class="svg-w">'+decodeURIComponent(data[i].content)+'</div>'
          );
        if(i % 4 == 3){
          svgDom.push('</div>');
        }
      }
      $('#svg-wrap').append(svgDom.join(''));
    }

    function setAllKey(k,value){
      for(var i = 0;i < saveSvg.length;i++){
        saveSvg[i][k] = value;
      }
    }
    var appendType = function(){
      var projectDom = [];
      for(var i = 0 ;i<project.length;i++){
        projectDom.push('<option value="'+project[i].projectId+'">'+project[i].projectName+'</option>')
      }
      $('#project').empty().append(projectDom.join(''));
      var typeDom = [];
      projectID = $('#project').val();
      setAllKey('projectId',projectID);
      for(var i = 0 ;i<project.length;i++){
        if(project[i].projectId == projectID){
          for(var k = 0;k<project[i].categoryList.length;k++){
            typeDom.push('<option value="'+project[i].categoryList[k].categoryId+'">'+project[i].categoryList[k].categoryName+'</option>')
          }
        }
      }
      $('#type').empty().append(typeDom);
      typeID = $('#type').val();
      setAllKey('categoryId',typeID);
    }
    $('#project').on('change',function(){
      projectID = $(this).val();
      setAllKey('projectId',projectID);
      var typeDom = [];
      for(var i = 0 ;i<project.length;i++){
        if(project[i].projectId == projectID){
          for(var k = 0;k<project[i].categoryList.length;k++){
            typeDom.push('<option value="'+project[i].categoryList[k].categoryId+'">'+project[i].categoryList[k].categoryName+'</option>')
          }
        }
      }
      $('#type').empty().append(typeDom);
    });
    $('#type').on('change',function(){
      typeID = $(this).val();
      setAllKey('categoryId',typeID);
    })

    $('#svg-name').change(function(){
      saveSvg[controli].name = encodeURIComponent($(this).val());
      versionRequest();
    })
    $('#upload-mark').change(function(){
      saveSvg[controli].remarks = $(this).val();
    })

    $('body').on('click','.svg-w',function(){
      $('.svg-w').removeClass('active');
      $(this).addClass('active');
      var i = parseInt($(this).attr('data-i'));
      controli = i;
      var message = saveSvg[i];
      $('#svg-name').val(decodeURIComponent(message.name||''));
      $('#upload-username').val(message.author||'');
      $('#upload-version').val(message.version == 0? 'New':'已存在'+(message.version)+'版');
      $('#upload-mark').val(message.remarks||'');
    })    
    
    $('#upload').on('click',function(){
      SMAction('pushdata',{action:'upload',data:saveSvg,version:saveversion});
      return;
    })
    $('#cancel').on('click',function(){
      SMAction('close');
      return;
    })

    function versionRequest(){
      var list = [];
      for(var i = 0;i<saveSvg.length;i++){
        list.push(encodeURIComponent(encodeURIComponent(saveSvg[i].name)));
      }
      SMAction('pushdata',{
        action:'version',
        list:list,
        projectid:projectID,
        categoryid:typeID
      })
    }
    var versionCheck = function(data){
      saveversion = 0;
      for(var i = 0;i<data.length;i++){
        saveSvg[i].version = data[i].version;
        if(data[i].version>0){
          saveversion++;
        }
      }
    }

    $('#svg-name').on('change',function(){
      saveSvg[controli].name = $(this).val();
      versionRequest();
      return;
    })

    

    $('#board-svg').click(function(){
      SMAction('pushdata',{
        action:'boardsvg'
      });
    })

    $('#file-svg').click(function(){
      SMAction('pushdata',{
        action:'filesvg'
      });
    })

    function uploadReturn(data){
      if(data.result == 200){
        SMAction('close');
      }
    }

    var init = function(data){
      svgUpload(data.svg);
      setAllKey('author',data.nametest);
      versionRequest();
      project = data.project;
      appendType();
      if(data.svg.length > 0){
        $('.svg-w:eq(0)').tigger('click');
      }
    }
    // init({svg:[{'name':'123123',content:'123'},{'name':'123123',content:'123'}],nametest:'123','project':[{'projectID':123},{'categoryList':[123,321]}]});

    window.addEventListener('hashchange', function(e) {
      return false;
    }, false);

  </script>
  </body>
</html>
